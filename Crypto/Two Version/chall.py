import os
from Crypto.Util.number import *
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad
from sage.all import *

secret = os.urandom(16)
secret = int.from_bytes(secret, 'big')

FLAG = ""
with open('flag.txt', 'r') as flag:
    FLAG = flag.read()

p = getPrime(1024)
q = getPrime(1024)
N1 = p * q
phi1 = (p - 1) * (q - 1)

hint = os.urandom(32)
e = getPrime(32) + (bytes_to_long(hint) * phi1)
hint = pow(secret, e, N1)

print(f"{N1 = }")
print(f"{e = }")

prime = getPrime(128)
phi = 1
N2 = 1
while N2.bit_length() < 2048:
    N2 *= prime
    phi *= (prime - 1)
    prime = next_prime(prime)

assert gcd(0x10001, phi) == 1

ct = pow(hint, 0x10001, N2)
print(f"N2 = {N2}")
print(f"ct = {ct}")

cipher = AES.new(long_to_bytes(secret), AES.MODE_ECB)
enc_flag = cipher.encrypt(pad(FLAG.encode(), 16))
print(f"enc_flag = {enc_flag}")

# N1 = 17362209236509579956069121909745118765799063323981053744694079912565491761665470166232725041911668984587357851108379264256444768723119405696823379326603919936432028254892304111890799155248313945504362228086008054153337335473581045441412224034029131473052839257492200434841614255071621144691873145779936936466540564808189303815230586143579770974537663138227520239222958954087051769031139540550385941998442389661281975075970676604559169389854098177253292054675455122805187979417072249915003812124619547817345238821993663526288499599335194728734483790328454191490869993428411439760162813987746438088527227601749820028193
# e = 568582705727074893855912262854931693776520061370825795622408975722616647195254499204299022659637745471845846557420791526279013376743846402285643895966976225319567903776419747592534878785237707018847064329521965900069329553901759652438404357571363572446084085687887505441095248254418448399269726503670730040360740992133710023103279528719378138713561929468837511729721619671738503296388639260766495550559585215630589053151303089778450120428975766990144168252012620202718975328284160837828555307103092360072925443331146944544205083563459507313906353592377402822356714725646404116880466954160143406854279706045105410824643858602601732293803652038686291057500387221541409697375265891315799717338405
# N2 = 174553024057014543990096002679862638088905851653879673222226052298055708844181812197941875851675416263226641449259760427101268268472069203586567587515794891047875245725162110718082616270544366434288997011409037775968719808654349176938207119625705703790242080128391560864432915193871137643173668518980792686437123926377623591683827956931115090648091374719966673705080651380216030247495007008029626444956423886177383838787824634354346012965466030223117377462983842249633655418289489207513555281526739138705675027976815421110574047635449979101326595680755121900431939859745287285869554512425317799105125963506050787144028639637446623602111823871042061393
# ct = 132963375508750110982747240401551817429093402914130496323529445591699573319732182982477592602548638283213896716757534905217268537453949332314065417291803810569772825403916533444924533708208557973427355332410755739881415766694571930525562269127527531894626120363166965760452473821975744785213257372447726685728346094300092678082137396501264318071662127385515962532743128346914780190335936819653183800050104005846840953382428383415290230446004794710008750774068731703819552901643139934566602333045031459877867709818046467532841903296594824234648604109806308639955400969917946294822261213855069675091607810871889832057748335243982627101739006805995485773
# enc_flag = b'\xe23\x8c\x89~\xce\\\x10\x85\xa7\x92)\x17zPu\x17Ny1\x82\x1a\xf4\x1bS\xa8\xcb\xe2\xb7\xf4\x07\x84\x93\xe6{\xc308\x94\xd0\xcfg\x96\xf2\x8dd\xa4"'